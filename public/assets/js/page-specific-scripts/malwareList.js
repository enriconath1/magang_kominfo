$(document).ready(function() {
    $('.filter-by-date').hide();
    $('#filter').change(function() {
        if ($(this).val() == 'filter-by-date') {
            $('.filter-by-date').removeAttr('style');
        }
        else {
            $('.filter-by-date').css('display', 'none');
            getPort($("#country").val(), "Date", "Date");
        }
    });

	function numberWithCommas(x) {
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

    $.ajax({
        type: "GET",
        url: "getCountry",
        cache: false,
        dataType: 'json',
        success: function(msg) {
            $("#country").append('<option value="all">All Countries</option>');
            $.each(msg, function(i, data) {
                if (data.countryCode == "ID") {
                    $('#country').append('<option value="' + data.countryCode + '" selected>' + data.countryName + '</option>');
                } else {
                    $('#country').append('<option value="' + data.countryCode + '">' + data.countryName + '</option>');
                }
            });
        }
    });
    getMalwareList("ID", "Date", "Date", 20, 0);
    getMalwareDetail("87136c488903474630369e232704fa4d")
});

function getMalwareList(country, from, to, limit, offset) {
    $.ajax({
        type: "GET",
        url: "getMalwares/" + country + "/" + from + "/" + to + "/" + limit + "/" + offset,
        cache: false,
        dataType: 'json',
        beforeSend: function() {
            $("#mlTable").css('display', 'none');
            $("#mlTableOuter").css('display', 'none');
            $("#mlList").html('<center><img src="public/assets/img/ajax-loader.gif" /><br/>Loading...</center>');
        },
        complete: function() {
            $("#mlList").html('');
			
        }, //Hide spinner
        dataType: 'json',
		success: function(msg) {
			$("#mlList").html('');
			$('#mlTable').removeAttr('style');
			$('#mlTableOuter').removeAttr('style');
			$('table#mlTable > tbody:last').empty();

			
			$.each(msg, function(i, data) {
				// url = "'" + data.vitolResult + "'";
				// md5 = "'" + data.malMd5 + "'";
				// $('table#mlTable > tbody:last').append('<tr ><td class="malware-table-td" style="cursor: pointer" onclick="getMalwareDetail(\'' + data.malMd5 + '\',\'' + data.vitolUrl + '\')"> <a href="#" data-toggle="modal" data-target="#malware-detail-modal">' + data.vitolResult + '</td><td class="right-aligned">' + numberWithCommas(data.count) + '</a></td><td><a href="#" class="btn btn-default"><i class="fa fa-download"></i> Download</a></td></tr>');
                $('table#mlTable > tbody:last').append('<tr ><td class="malware-table-td" style="cursor: pointer" onclick="getMalwareDetail(\'' + data.malwareMd5 + '\',\'' + data.malwareUrl + '\')"> <a href="#" data-toggle="modal" data-target="#malware-detail-modal">' + data.scanResult + '</td><td>' + data.count + '</a></td><td><a href="#" class="btn btn-default"><i class="fa fa-download"></i> Download</a></td></tr>');
			});
			if (msg.length >= limit)
				$('table#mlTable > tbody:last').append('<tr class="load-more-tr"><td colspan="3"><button style="width:200px;" class="btn btn-default load-more" onclick="getAdditionalMalware(\'' + country + '\',\'' + from + '\', \'' + to + '\', ' + limit + ', ' + (offset + limit) + ')">Load More</button></td></tr>');

		}
    });
}

function getAdditionalMalware(country, from, to, limit, offset) {
    country = country.split(/[\-_'\s]/);


    $.ajax({
        type: "GET",
        url: "getMalwares/" + country[0] + "/" + from + "/" + to + "/" + limit + "/" + offset,
        cache: false,
        beforeSend: function() {
            $('.load-more-tr').css('display', 'none');
            $("table#mlTable > tbody:last").append('<center class="load-other"><img style="margin-left: 90px;" src="public/assets/img/ajax-loader-1.gif" /></center>');
        },
        complete: function() {
            $(".load-other").css('display', 'none');
        }, //Hide spinner
        dataType: 'json',
        success: function(msg) {

            $.each(msg, function(i, data) {
                $('table#mlTable > tbody:last').append('<tr ><td class="malware-table-td" style="cursor: pointer" onclick="getMalwareDetail(\'' + data.malMd5 + '\',\'' + data.vitolUrl + '\')"> <a href="#" data-toggle="modal" data-target="#malware-detail-modal">' + data.vitolResult + '</td><td>' + data.count + '</a></td><td><a href="#" class="btn btn-default"><i class="fa fa-download"></i> Download</a></td></tr>');
            });
            if (msg.length >= limit)
                $('table#mlTable > tbody:last').append('<tr class="load-more-tr"><td colspan="3"><button style="width:200px;" class="btn btn-default load-more" onclick="getAdditionalMalware(\'' + country + '\',\'' + from + '\', \'' + to + '\', ' + limit + ', ' + (offset + limit) + ')">Load More</button></td></tr>');
        }
    });


}

function getMalwareDetail(md5, url) {
    $.ajax({
        type: "GET",
        url: "getMalwareData/" + md5,
        cache: false,
        dataType: 'json',
        beforeSend: function() {
            $("#vt-table").css('display', 'none');
            $("#vt-div").html('<center><img src="public/assets/img/ajax-loader.gif" /><br/>Loading...</center>');
            $("#result").html('');
        },
        complete: function() {
            $("#vt-div").html('');
            $("#result").html('<b>MD5 Hash: </b>' + md5);
        }, //Hide spinner
        success: function(msg) {
            $("#vt-table").removeAttr('style');
            $('table#vt-table > tbody:last').empty();
            $.each(msg, function(i, data) {
                $('table#vt-table > tbody:last').append('<tr><td>' + data.virusTotalScanner + '</td><td>' + data.virusTotalResult + '</td></tr>');
            });
            $('table#vt-table > tbody:last').append('<tr><td colspan=2><a href="' + url + '" target="_blank">Complete details on virustotal.com</a></td></tr>');
        }
    });

//        $.ajax({
//            type: "GET",
//            url: "getMalwareData/"+md5,
//            cache: false,
//            dataType: 'json',
//            beforeSend: function() {
//                $("#vt-table").css('display', 'none');
//                $("#vt-div").html('<center><img src="public/assets/img/ajax-loader.gif" /><br/>Loading...</center>');
//            },
//            complete: function() {
//                $("#vt-div").html('');
//            }, //Hide spinner
//            dataType: 'json',
//            success: function(msg) {
////                $('#mlDetailTable').removeAttr('style');
//                $('table#vt-table > tbody:last').empty();
//                $.each(msg, function(i, data) {
//                  $('table#vt-table > tbody:last').append('<tr ><td style="cursor: pointer">' + data.virustotalscan_scanner + '</td><td>' + data.virustotalscan_result + '</td></tr>');
//                  $('table#mlTable > tbody:last').append('<tr ><td style="cursor: pointer" onclick="getMalwareDetail('+url+')"> <a href="#detail-modal" data-toggle="modal">' + data.download_md5_hash + '</td><td>' + data.malware_count + '</a></td></tr>');
//                });
//            }
//        });


//        document.getElementById("virustotal").innerHTML = "<a href='"+url+"'>Complete URL</a>";
}